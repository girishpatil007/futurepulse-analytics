<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Pulse - Inventory Prediction</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai"></script>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <link rel="stylesheet" href="/src/styles/main.css">
</head>

<body>
    <div id="root"></div>
    <div id="chat-widget" class="fixed bottom-4 right-4 z-50">
        <div id="chat-container"></div>
    </div>

    <script type="module">
        import Header from './src/components/Header.tsx';
        import UploadForm from './src/components/UploadForm.tsx';
        
        // Initialize chat widget
        const genAI = new GoogleGenerativeAI("YOUR_API_KEY_HERE");
        
        // File input handling
        document.getElementById('file-input').addEventListener('change', function(e) {
            let fileName = e.target.files[0]?.name || 'No file selected';
            document.querySelector('.upload-button').innerHTML = `
                <span class="upload-icon"></span>
                ${fileName}
                <div class="button-illustration"></div>
            `;
        });

        // Form submission
        document.getElementById('prediction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            document.getElementById('loadingContainer').style.display = 'block';

            fetch('/predict/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingContainer').style.display = 'none';
                updateCharts(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingContainer').style.display = 'none';
            });
        });

        function createGradient(colorStart, colorEnd) {
            const ctx = document.createElement('canvas').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        function createChartOptions(yLabel, xLabel) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#E4E6F0',
                            font: { family: 'Poppins' }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            color: '#E4E6F0',
                            font: { family: 'Poppins' }
                        }
                    },
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            color: '#E4E6F0',
                            font: { family: 'Poppins' }
                        }
                    }
                }
            };
        }

        function initializeCharts() {
            const charts = {};
            
            charts.trendChart = new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Predicted Inventory',
                        data: [],
                        borderColor: '#6C63FF',
                        backgroundColor: createGradient('rgba(108, 99, 255, 0.2)', 'rgba(108, 99, 255, 0)'),
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: createChartOptions('Quantity', 'Time')
            });
            
            // Initialize other charts similarly
            return charts;
        }

        let charts = initializeCharts();

        // Loading animation timeout
        setTimeout(() => {
            const loadingContainer = document.getElementById('loadingContainer');
            loadingContainer.classList.add('hidden');
        }, 5000);

        // Chat Widget Implementation
        const genAI = new GoogleGenerativeAI("AIzaSyBpvqSOdBFZcuakjv3CpJd5zl92eDNx58w");

        async function handleChatMessage(message) {
            const model = genAI.getGenerativeModel({ model: "gemini-pro" });
            try {
                const result = await model.generateContent(message);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error("Error calling Gemini:", error);
                throw error;
            }
        }

        class ChatWidget extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    isOpen: false,
                    messages: [],
                    input: "",
                    isLoading: false
                };
            }

            handleSend = async () => {
                if (!this.state.input.trim()) return;

                try {
                    this.setState({ isLoading: true });
                    const userMessage = { role: "user", content: this.state.input };
                    this.setState(prev => ({
                        messages: [...prev.messages, userMessage],
                        input: ""
                    }));

                    const response = await handleChatMessage(this.state.input);
                    const assistantMessage = { role: "assistant", content: response };
                    this.setState(prev => ({
                        messages: [...prev.messages, assistantMessage]
                    }));
                } catch (error) {
                    console.error("Chat error:", error);
                } finally {
                    this.setState({ isLoading: false });
                }
            }

            render() {
                return React.createElement("div", null,
                    this.state.isOpen ? (
                        React.createElement("div", { 
                            className: "w-96 h-[600px] glass-panel rounded-lg flex flex-col overflow-hidden animate-fade-up"
                        },
                            React.createElement("div", { 
                                className: "p-4 border-b border-white/10 flex items-center justify-between bg-gradient-to-r from-purple-500/50 to-blue-900/50"
                            },
                                React.createElement("div", { 
                                    className: "flex items-center gap-2"
                                },
                                    React.createElement("span", { 
                                        className: "font-semibold text-white"
                                    }, "Future Pulse AI")
                                ),
                                React.createElement("button", {
                                    onClick: () => this.setState({ isOpen: false }),
                                    className: "hover:bg-white/10 p-2 rounded"
                                }, "Ã—")
                            ),
                            React.createElement("div", {
                                className: "flex-1 overflow-y-auto p-4 space-y-4"
                            },
                                this.state.messages.map((message, index) =>
                                    React.createElement("div", {
                                        key: index,
                                        className: `max-w-[80%] rounded-lg p-3 ${
                                            message.role === "user"
                                                ? "bg-purple-500/20 ml-auto"
                                                : "bg-blue-900/20 mr-auto"
                                        }`
                                    }, message.content)
                                )
                            ),
                            React.createElement("div", {
                                className: "p-4 border-t border-white/10 bg-gradient-to-r from-purple-500/10 to-blue-900/10"
                            },
                                React.createElement("form", {
                                    onSubmit: (e) => {
                                        e.preventDefault();
                                        this.handleSend();
                                    },
                                    className: "flex gap-2"
                                },
                                    React.createElement("input", {
                                        value: this.state.input,
                                        onChange: (e) => this.setState({ input: e.target.value }),
                                        placeholder: "Type your message...",
                                        className: "flex-1 bg-white/5 border border-white/10 rounded px-3 py-2 text-white placeholder:text-white/50",
                                        disabled: this.state.isLoading
                                    }),
                                    React.createElement("button", {
                                        type: "submit",
                                        disabled: this.state.isLoading,
                                        className: "bg-gradient-to-r from-purple-500 to-blue-900 hover:from-purple-600 hover:to-blue-800 px-4 py-2 rounded text-white"
                                    }, "Send")
                                )
                            )
                        )
                    ) : (
                        React.createElement("button", {
                            onClick: () => this.setState({ isOpen: true }),
                            className: "rounded-full w-14 h-14 animate-fade-up bg-gradient-to-r from-purple-500 to-blue-900 hover:from-purple-600 hover:to-blue-800 text-white flex items-center justify-center"
                        }, "ðŸ’­")
                    )
                );
            }
        }

        // Initialize React components
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            React.createElement(React.Fragment, null,
                React.createElement(Header),
                React.createElement(UploadForm)
            )
        );

        // Initialize chat widget
        const chatContainer = document.getElementById('chat-container');
        const chatRoot = ReactDOM.createRoot(chatContainer);
        chatRoot.render(React.createElement(ChatWidget));
    </script>
</body>
</html>
